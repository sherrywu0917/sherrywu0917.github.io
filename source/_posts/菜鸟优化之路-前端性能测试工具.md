---
title: 菜鸟优化之路-前端性能测试工具sitespeed.io
date: 2018-10-09 20:08:27
tags: [前端性能优化, sitespeed.io]
---
## 制定优化目标
### 度量标准
- 首次有效绘制（First Meaningful Paint，简称FMP，当主要内容呈现在页面上）
- 英雄渲染时间（Hero Rendering Times，度量用户体验的新指标，当用户最关心的内容渲染完成）
- 可交互时间（Time to Interactive，简称TTI，指页面布局已经稳定，关键的页面字体是可见的，并且主进程可用于处理用户输入，基本上用户可以点击UI并与其交互）
- 输入响应（Input responsiveness，界面响应用户输入所需的时间）
- 感知速度指数（Perceptual Speed Index，简称PSI，测量页面在加载过程中视觉上的变化速度，分数越低越好）
- 自定义指标，由业务需求和用户体验来决定。
FMP与英雄渲染时间非常相似，但它们不一样的地方在于FMP不区分内容是否有用，不区分渲染出的内容是否是用户关心的。

### 设定目标
基于[RAIL](https://developers.google.com/web/fundamentals/performance/rail?hl=zh-cn)模型去制定优化的目标，`RAIL`是一种以用户为中心的性能模型，主要从响应、动画、空闲、加载四个层面去衡量页面性能。
<!-- more -->
**1. 100 毫秒的响应时间 + 每秒60帧**
每帧动画应在少于 16 毫秒（理想情况下为 10 毫秒）内完成，从而达到每秒 60 帧（1 秒 ÷ 60 = 16.6毫秒）。保持乐观，明智地利用空闲时间。对于像动画这样的高压点，只要能，就不要做任何其它事情。预计输入延迟时间（Estimated Input Latency）应低于 50 毫秒。

**2. 速度指数（SpeedIndex）小于 1250，可交互时间（Time-To-Interactive）在 3G 上小于 5 秒**
Speed Index是指获取可见页面加载的视觉进度，并计算内容绘制速度的总得分，分数越低，性能越好，具体的计算可参考[speed-index](https://sites.google.com/a/webpagetest.org/docs/using-webpagetest/metrics/speed-index)。
目标是在 1 秒内（在高速网络下）完成首次绘制（FMP），速度指数（SpeedIndex）低于 1250 毫秒。考虑速度基线是一台有着 3G 网络的，价格为 200 美元左右的 Android 手机（译注：国产千元机水平），那么可以以 400 毫秒 RTT 和 400kb/s 的传输速度进行网络模拟，以达成可交互时间（Time-To-Interactive）小于 5 秒，第二次打开的速度低于 2 秒。尽你所能地降低这些指标。

**3. 核心块 = 15kb，关键文件 < 170 kb**
HTML 的前 14~15kb 是最关键的核心块（chunk），也是整个文件中唯一可以在第一个 RTT 内被下载的部分。要实现上述目标，请设定关键文件的最大尺寸“预算”。170kb gzip 后的文件（原始文件尺寸 0.8~1mb），在普通手机上可能需要 1 秒才能解析和编译完成。

## sitespeed.io工具
[Sitespeed.io](https://www.sitespeed.io/)是一个基于最佳实践以及一些加载时序等量化标准的开源工具，有助于开发者分析网页的加载速度和渲染性能。它拥有一套插件，如[Coach](https://www.sitespeed.io/documentation/coach/)、[Broswertime](https://www.sitespeed.io/documentation/browsertime/)、[Chrome-HAR](https://github.com/sitespeedio/chrome-har)等，帮助sitespeed搜集浏览器debug状态下的数据，并基于网站最佳实践给出相应的打分和意见，最后把数据可视化展示。
sitespeed.io评价网页的主要依据是：浏览器的网络请求和TimeLine中的Time Event。
与[webpageTest](https://www.webpagetest.org/)、[PageSpeed Insights](https://developers.google.com/speed/pagespeed/insights/)等只能测试线上站点不同，**`sitespeed.io`可以测试本地运行的，以及测试环境绑定代理的站点**。

### 安装
可以直接安装`sitespeed.io`的npm包。
``` bash
npm install -g sitespeed.io
yarn add global sitespeed.io
```
也可以使用`docker`或者`git clone`的方式安装，具体可参考[npm-sitespeed.io](https://www.npmjs.com/package/sitespeed.io)。

#### 安装遇到的问题
在安装过程中有遇到一些问题，具体的问题和解决办法记录在这儿。
1.修复npm安装时报VCBuild不存在的错误，参考[stackoverflow](https://stackoverflow.com/questions/21658832/npm-install-error-msb3428-could-not-load-the-visual-c-component-vcbuild-ex/39235952#39235952)给出的解决方案。
``` bash
npm install --global --production windows-build-tools
```

2.`Browser failed to start, could not find ...alto-saxophone\vendor\chromedriver.exe`
查看node-modules/alto-saxophone目录，发现该目录下对应的文件缺失，可以在该目录下运行`npm run install`命令手动安装`chromedriver.exe`。
``` bash
npm run install
```

3.运行sitespeed.io报错
``` bash
$ sitespeed.io https://www.sitespeed.io/
module.js:682
  return process.dlopen(module, path._makeLong(filename));
Error: The specified module could not be found.
\\?\C:\Users\hzwushuoshuo\AppData\Roaming\npm\node_modules\sitespeed.io\node_modules\sharp\build\Release\sharp.node
```
查看安装`sitespeed.io`的过程，发现在安装`sharp`包时报错`UnhandledPromiseRejectionWarning`，需要在admin模式下去安装文件。

### 运行
``` bash
sitespeed.io -n 5 -v https://www.baidu.com
```
该命令将会在chrome浏览器下调起URL为https://www.baidu.com 5次。如果期望一次检测多个页面，可以继续拼接参数，如下所示。
```
sitespeed.io -n 5 -v https://www.baidu.com -v https://www.baidu.com/s?wd=test
```
生成的文件可以在`sitespeed-result`文件夹中查看。
<img src="/image/sitespeed_result.png">

### 运行结果
打开`sitespeed.io`输出的html文件，可以查看`Summary`、`Detailed Summary`、`Pages`、`Domains`、`Toplist`和`Assets`六个维度的信息。
**Summary**
<img src="/image/sitespeed_summary.png"  width="900px">
`Summary`是对网页性能数据的一个整体展示。站点得分主要根据页面性能（Performance）、可用性（Accessibility）和 Web最佳实践（Web Best Practice）三个核心指标进行打分，每个核心指标考核的内容可以在help.html文件中查找。
页面中的其他指标，如文件压缩、文件大小、请求数、缓存时间、请求状态码、首次渲染时间、前端渲染用时、页面加载用时、DNS解析时长等，这些指标都有详细的统计，而且不同等级用相应的颜色表示。

**Detailed Summary**
<img src="/image/sitespeed_details.png"  width="900px">
点击左侧具体的指标，都可以在帮助文档中查看对该指标的解释。针对每个指标都计算除了最小(min)、最大(max)、平均值(mean)、中位数(median)和加载90%(p90)时的数据。

**Pages**
<img src="/image/sitespeed_pages.png"  width="900px">
如果一次测试多个页面，可以在`Pages`tab下面查看到不同的页面。点击某个页面的URL可以查看到页面的加载细节，包括资源请求的waterfall瀑布流图：
<img src="/image/sitespeed_waterfall.png"  width="900px">
在上图的`coach`Tab下有页面性能（Performance）、可用性（Accessibility）和 Web最佳实践（Web Best Practice）三个核心指标下各个细分项的得分，并给出了优化建议，如下图所示。
<img src="/image/sitespeed_coach.png"  width="900px">

**Domains**
<img src="/image/sitespeed_domains.png"  width="900px">
`Domains`tab下主要是对按域名统计，各个域名下的请求时间和请求数。

**Toplist**
<img src="/image/sitespeed_toplist.png"  width="900px">
`Toplist`会列出所有大的文件，包括JS、CSS、HTML和图片，此外还会列出所有慢的请求。

**Assets**
<img src="/image/sitespeed_assets.png"  width="900px">
`Assets`显示了所有被加载资源的前20个，包括文件类型、last-modified时间、缓存时间、文件大小等数据。

REFS:
[2018 前端性能检查表](https://juejin.im/post/5ac1d117f265da2396128b9f)
[嗨，送你一张Web性能优化地图](https://zhuanlan.zhihu.com/p/40197752)
[好用的前端页面性能检测工具—sitespeed.io](https://cloud.tencent.com/developer/article/1033153)
