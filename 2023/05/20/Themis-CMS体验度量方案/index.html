<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
  <title>Themis-CMS体验度量方案 | lying fox</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="背景Themis为CMS体验优化项目，目标是提高CMS相关的体验和性能，主要的服务用户是：策划、开发、运营，主要工作包括：  脚手架移动化改造和场景组件封装 性能监控 效能工具的开发本文主要介绍‘性能监控’的设计方案和实现，为了可以有效地衡量cms的性能数据，我们会从多个角度去度量应用相关的数据，进而分析出页面存在的体验问题并治理。  架构图Themis性能监控处理了从数据生成、收集、计算到可视化">
<meta name="keywords" content="Themis，CMS体验度量方案">
<meta property="og:type" content="article">
<meta property="og:title" content="Themis-CMS体验度量方案">
<meta property="og:url" content="https://sherrywu0917.github.io/2023/05/20/Themis-CMS体验度量方案/index.html">
<meta property="og:site_name" content="lying fox">
<meta property="og:description" content="背景Themis为CMS体验优化项目，目标是提高CMS相关的体验和性能，主要的服务用户是：策划、开发、运营，主要工作包括：  脚手架移动化改造和场景组件封装 性能监控 效能工具的开发本文主要介绍‘性能监控’的设计方案和实现，为了可以有效地衡量cms的性能数据，我们会从多个角度去度量应用相关的数据，进而分析出页面存在的体验问题并治理。  架构图Themis性能监控处理了从数据生成、收集、计算到可视化">
<meta property="og:locale" content="default">
<meta property="og:image" content="https://p6.music.126.net/obj/wo3DlcOGw6DClTvDisK1/15009464919/17fe/2097/e368/4220300df2199192169a19dae63496da.png">
<meta property="og:image" content="https://p5.music.126.net/obj/wonDlsKUwrLClGjCm8Kx/15045900125/9dab/d7ea/7b93/b408a64ba63857093e01bce54c22c67f.png">
<meta property="og:image" content="https://p6.music.126.net/obj/wo3DlcOGw6DClTvDisK1/15048205515/b8f9/ef54/d53a/b9b13d5ee84433c75cf0f83d8d101956.png">
<meta property="og:image" content="https://p6.music.126.net/obj/wo3DlcOGw6DClTvDisK1/15048248406/b7b1/d59f/6e2c/bef24fb46cccc6b56159e02ad82a8d6f.png">
<meta property="og:updated_time" content="2024-02-19T04:51:45.044Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Themis-CMS体验度量方案">
<meta name="twitter:description" content="背景Themis为CMS体验优化项目，目标是提高CMS相关的体验和性能，主要的服务用户是：策划、开发、运营，主要工作包括：  脚手架移动化改造和场景组件封装 性能监控 效能工具的开发本文主要介绍‘性能监控’的设计方案和实现，为了可以有效地衡量cms的性能数据，我们会从多个角度去度量应用相关的数据，进而分析出页面存在的体验问题并治理。  架构图Themis性能监控处理了从数据生成、收集、计算到可视化">
<meta name="twitter:image" content="https://p6.music.126.net/obj/wo3DlcOGw6DClTvDisK1/15009464919/17fe/2097/e368/4220300df2199192169a19dae63496da.png">
  
    <link rel="alternate" href="/atom.xml" title="lying fox" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">lying fox</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://sherrywu0917.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-Themis-CMS体验度量方案" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2023/05/20/Themis-CMS体验度量方案/" class="article-date">
  <time datetime="2023-05-20T04:12:12.000Z" itemprop="datePublished">2023-05-20</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Themis-CMS体验度量方案
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>Themis为CMS体验优化项目，目标是提高CMS相关的体验和性能，主要的服务用户是：策划、开发、运营，主要工作包括：</p>
<ul>
<li>脚手架移动化改造和场景组件封装</li>
<li>性能监控</li>
<li>效能工具的开发<br>本文主要介绍‘性能监控’的设计方案和实现，为了可以有效地衡量cms的性能数据，我们会从多个角度去度量应用相关的数据，进而分析出页面存在的体验问题并治理。</li>
</ul>
<h2 id="架构图"><a href="#架构图" class="headerlink" title="架构图"></a>架构图</h2><p>Themis性能监控处理了从数据生成、收集、计算到可视化的整个链路，流程架构图如下所示，主要包括三方面：</p>
<ul>
<li>场景指标定义</li>
<li>数据收集&amp;上报：ThemisLogger SDK</li>
<li>监控数据可视化：ThemisAnalysis 平台<br><img src="https://p6.music.126.net/obj/wo3DlcOGw6DClTvDisK1/15009464919/17fe/2097/e368/4220300df2199192169a19dae63496da.png" width="560"></li>
</ul>
<h2 id="场景指标定义"><a href="#场景指标定义" class="headerlink" title="场景指标定义"></a>场景指标定义</h2><p>首先明确CMS侧主要的场景可以归纳为表格和表单两种，在「场景组件封装」中，我们对这类交互进行了标准化定义，详情可以参考<a href="https://music-cms.hz.netease.com/themis/standards/situations/table" target="_blank" rel="noopener">场景规范</a>。<br>那么问题的关键就转化为：如何对这两种场景进行度量？<br>以表格场景为例，在用户操作的时候，我们会重点关注操作的易用性、页面渲染速度和高频行为等，从中我们抽象出表格场景的核心指标有：</p>
<ul>
<li>查询效率</li>
<li>页码切换性能</li>
<li>场景初始化性能</li>
<li>筛选区操作效率</li>
<li>用户高频行为</li>
</ul>
<p>为了度量出具体的核心指标，我们需要去定义具体的行为类型、指标计算规则，记录行为队列。</p>
<h3 id="行为类型定义"><a href="#行为类型定义" class="headerlink" title="行为类型定义"></a>行为类型定义</h3><p>首先针对关注的表格核心指标，定义行为类型，例如在表格场景中搜索的点击<code>search</code>，表格渲染结束<code>RenderEnd</code><br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ActionType = &#123;</span><br><span class="line">    PageChange: <span class="string">'pageChange'</span>, <span class="comment">// 页码变化</span></span><br><span class="line">    Search: <span class="string">'search'</span>, <span class="comment">// 搜索点击</span></span><br><span class="line">    SceneInit: <span class="string">'sceneInit'</span>, <span class="comment">// 场景初始化</span></span><br><span class="line">    RenderEnd: <span class="string">'renderEnd'</span>, <span class="comment">// 所有的表格内容渲染完成</span></span><br><span class="line">    FilterValueChange: <span class="string">'filterValueChange'</span>, <span class="comment">// 搜索条件变更</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="行为计算规则定义"><a href="#行为计算规则定义" class="headerlink" title="行为计算规则定义"></a>行为计算规则定义</h3><p>我们关注的表格核心指标有：</p>
<ul>
<li>查询耗时 = 渲染完成时间 - 搜索触发时间（RenderEnd - Search）</li>
<li>页码切换耗时 = 渲染完成时间 - 页码切换时间（RenderEnd - PageChange)</li>
<li>场景初始化耗时 = 渲染完成时间 - 场景初始化时间（RenderEnd - SceneInit)</li>
<li>筛选表单操作时长 = 搜索开始时间 - 表单开始操作时间 (Search - filterValueChange)</li>
<li>用户高频行为 = sort([页面]-[表格]-[行为])</li>
</ul>
<h4 id="计算前置关系"><a href="#计算前置关系" class="headerlink" title="计算前置关系"></a>计算前置关系</h4><p>针对已经定义的行为类型，如果要计算【行为1】到【行为2】之间的耗时，则可以将【行为1】放到【行为2】对应的前置行为数组。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 定义需要计算的[行为1]_[行为2]的耗时</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="built_in">window</span>.Themis.PreActionMap = &#123;</span><br><span class="line">    <span class="string">'行为2'</span>: [</span><br><span class="line">        <span class="string">'行为1'</span>,</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>对于【行为2】，可能有多个行为会触发，例如针对页面渲染的场景，【RenderEnd行为】可以是Search、PageChange、SceneInit多个行为触发，这些行为都可以放到【RenderEnd行为】对应的前置行为数组。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>.Themis.PreActionMap = &#123;</span><br><span class="line">    [ActionType.RenderEnd]: [</span><br><span class="line">        ActionType.PageChange,</span><br><span class="line">        ActionType.Search,</span><br><span class="line">        ActionType.SceneInit,</span><br><span class="line">        ActionType.FilterValueChange,</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="计算顺序"><a href="#计算顺序" class="headerlink" title="计算顺序"></a>计算顺序</h4><p>在计算耗时的时候，需要区分两种顺序：</p>
<ul>
<li>NEAR: 最近的触发行为去计算，如RenderEnd行为耗时的计算(RenderEnd - 最近一次触发渲染的时间)</li>
<li>FAR: 最远的触发行为去计算，如<code>筛选表单操作时长</code>指标的计算（搜索开始时间 - 表单开始操作时间）<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>.Themis.CountRule = &#123;</span><br><span class="line">    NEAR: [ActionType.RenderEnd],</span><br><span class="line">    FAR: [ActionType.Search]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="行为队列"><a href="#行为队列" class="headerlink" title="行为队列"></a>行为队列</h3><p>定义好行为类型和计算规则后，在触发需要打点的行为时，场景组件会将action对象push到<code>window.Themis.ActionQueue</code>数组中，action对象结构如下：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@def <span class="type">&#123;object&#125;</span> </span>action 行为对象</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@def <span class="type">&#123;string&#125;</span> </span>action.name 行为名 必须</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@def <span class="type">&#123;number&#125;</span> </span>action.time 行为发生时间戳 必须</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@def <span class="type">&#123;string&#125;</span> </span>action.scene 所属场景 必须</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@def <span class="type">&#123;string&#125;</span> </span>action.url 所属页面 必须 location.href</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@def <span class="type">&#123;object&#125;</span> </span>[action.attributes] 其他行为属性，必须是可枚举 可选</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="keyword">const</span> action = &#123;</span><br><span class="line">   name: ActionType.FilterValueChange,</span><br><span class="line">   time: <span class="number">1605531890117</span>,</span><br><span class="line">   scene: <span class="string">'Table'</span> ,</span><br><span class="line">   url: <span class="string">'http://cms.qa.igame.163.com/pagexxx'</span>,</span><br><span class="line">   attributes: &#123;</span><br><span class="line">       attr: <span class="number">1</span></span><br><span class="line">   &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>若用户多次触发行为，则会持续向行为队列中push action对象，该行为队列存储在本地，在满足预设的条件时会被ThemisLogger SDK收集、格式化处理并上报到服务端。</p>
<h2 id="数据收集-amp-上报"><a href="#数据收集-amp-上报" class="headerlink" title="数据收集&amp;上报"></a>数据收集&amp;上报</h2><p>ThemisLogger SDK负责收集页面相关的性能数据并上报，主要工作包括：</p>
<ul>
<li>场景行为数据收集</li>
<li>指标数据计算&amp;上报</li>
<li>异常ErrorCode捕获</li>
<li>请求耗时上报</li>
<li>页面停留时间上报<br>该SDK可以通过<a href="https://music-fet.hz.netease.com/puzzle/web/projects/1/apps" target="_blank" rel="noopener">Puzzle</a>平台去接入，通过动态js下发的方式去引入SDK，无需入侵项目代码。<h3 id="场景指标上报"><a href="#场景指标上报" class="headerlink" title="场景指标上报"></a>场景指标上报</h3><h4 id="场景指标上报时机"><a href="#场景指标上报时机" class="headerlink" title="场景指标上报时机"></a>场景指标上报时机</h4>可以触发场景指标上报的条件有多个，用于处理不同的场景，包括：</li>
<li>定时10s上报一次：最通用的上报触发条件</li>
<li>页面离开时触发上报：处理页面被关闭的情况</li>
<li>行为队列长度超过100触发上报: 用于处理数据量过大的情况<br>定时上报、页面离开时触发上报都很好处理，难点在于如何监听行为队列长度的变化，对行为队列的修改内置在场景组件中，与SDK无直接通信，并且不希望在场景组件中耦合上报相关逻辑，保持代码职责的专一性。鉴于行为队列是一个数组，首先封装了<code>observeArray</code>方法对<code>window.Themis.ActionQueue</code>会用到的数组方法原型进行重写，这样，在对该数组进行<code>push</code>、<code>pop</code>等操作时，就可以在回调方法中去判断数据长度<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 监听数组</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;array&#125;</span> </span>arr </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;function&#125;</span> </span>callback </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">observeArray</span>(<span class="params">arr, callback</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> arrayMethods = <span class="built_in">Object</span>.create(<span class="built_in">Array</span>.prototype);</span><br><span class="line">  <span class="keyword">const</span> newArrProto = [];</span><br><span class="line">  [</span><br><span class="line">    <span class="string">'push'</span>,</span><br><span class="line">    <span class="string">'pop'</span>,</span><br><span class="line">    <span class="string">'shift'</span>,</span><br><span class="line">    <span class="string">'unshift'</span>,</span><br><span class="line">    <span class="string">'splice'</span>,</span><br><span class="line">    <span class="string">'sort'</span>,</span><br><span class="line">    <span class="string">'reverse'</span></span><br><span class="line">  ].forEach(<span class="function"><span class="params">method</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> original = arrayMethods[method];</span><br><span class="line">    newArrProto[method] = <span class="function"><span class="keyword">function</span> (<span class="params">...args</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">const</span> result = original.apply(<span class="keyword">this</span>, args);</span><br><span class="line">      callback &amp;&amp; callback()</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="built_in">Object</span>.setPrototypeOf(arr, newArrProto);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>此外，在SDK初始化的时候，<code>window.Themis.ActionQueue</code>可能尚未被初始化，针对此情况，定义了<code>observeObj</code>方法去监听<code>window.Themis.ActionQueue</code>的赋值，内部逻辑基于<code>Object.defineProperty</code>的<code>setter</code>和<code>getter</code>去实现。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 监听对象</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;object&#125;</span> </span>obj </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;string&#125;</span> </span>key </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;function&#125;</span> </span>callback </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">observoObj</span>(<span class="params">obj, key, callback</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!obj || !key) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> newValue;</span><br><span class="line">  <span class="built_in">Object</span>.defineProperty(obj, key, &#123;</span><br><span class="line">    <span class="keyword">set</span>: function(value) &#123;</span><br><span class="line">      newValue = value;</span><br><span class="line">      <span class="keyword">if</span>(<span class="built_in">Array</span>.isArray(value)) &#123;</span><br><span class="line">          observeArray(obj[key], callback);</span><br><span class="line">      &#125;</span><br><span class="line">      callback &amp;&amp; callback(newValue);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="keyword">get</span>: function() &#123;</span><br><span class="line">      <span class="keyword">return</span> newValue;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 监听window.Themis.ActionQueue的变化</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">observeActionQueue</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">window</span>.Themis.ActionQueue) &#123;</span><br><span class="line">        observeArray(<span class="built_in">window</span>.Themis.ActionQueue, onActionQueueChange);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        observeObj(<span class="built_in">window</span>.Themis, <span class="string">'ActionQueue'</span>, onActionQueueChange);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="场景指标计算"><a href="#场景指标计算" class="headerlink" title="场景指标计算"></a>场景指标计算</h4><p>在满足指标上报条件后，会对行为队列的数据进行计算，根据前一章定义的计算规则将其转换为<code>Event</code>数据结构：<br><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> IEvent &#123;</span><br><span class="line">    name: <span class="built_in">string</span>; <span class="comment">// eg: 'cmsAction'｜'errorCode'|'requestTimeConsume'等</span></span><br><span class="line">    value: <span class="built_in">number</span>; <span class="comment">// 耗时时间戳</span></span><br><span class="line">    attributes: &#123;</span><br><span class="line">        actionName: <span class="built_in">string</span>; <span class="comment">// eg: `$&#123;ActionType.Search&#125;_$&#123;ActionType.RenderEnd&#125;`</span></span><br><span class="line">        ... <span class="comment">// 其他属性</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在计算的过程中，需要对行为队列中的数据进行过滤，对于满足计算规则的行为队列上报为<code>cmsAction</code>类型，对于异常的行为队列也需要上报，类型为<code>errorActionQueue</code>，因为异常的行为队列，很可能反应了页面存在的一些问题。</p>
<h3 id="请求数据处理"><a href="#请求数据处理" class="headerlink" title="请求数据处理"></a>请求数据处理</h3><p>因为CMS底层调用的<code>fetch</code>方法，要捕获请求耗时、异常ErrorCode、返回数据等请求相关数据，可以通过拦截<code>fetch</code>方法，置入功能插件去做处理，核心代码如下：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> interceptFetch = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> fetch = <span class="built_in">window</span>.fetch;</span><br><span class="line">    <span class="built_in">window</span>.fetch = <span class="function">(<span class="params">...args</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 顺序从下向上执行</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">const</span> config = args[<span class="number">1</span>] || &#123;&#125;;</span><br><span class="line">        <span class="keyword">const</span> plugins = [</span><br><span class="line">            errorPlugin(config),</span><br><span class="line">            dataFormatter(config),</span><br><span class="line">            timeConsumePlugin(config),</span><br><span class="line">        ];</span><br><span class="line">        <span class="keyword">return</span> composePlugin(...plugins)(fetch.apply(<span class="built_in">window</span>, args));</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>设计实现了三个功能插件：</p>
<ul>
<li><code>timeConsumePlugin</code>时间耗时插件</li>
<li><code>dataFormatter</code>数据格式化插件</li>
<li><code>errorPlugin</code>错误捕获插件</li>
</ul>
<p>当请求发出的时候，会按顺序逐个执行功能插件，执行的顺序为：<code>timeConsumePlugin -&gt; dataFormatter -&gt; errorPlugin</code>，需要注意的关键点有：</p>
<ul>
<li>在<code>timeConsumePlugin</code>插件中，需要通过闭包的方式去记录下当前请求的开始时间，在请求返回的时候，拿到返回时间，进而计算出请求耗时时间；</li>
<li><code>dataFormatter</code>插件对response数据处理时，不能直接调用<code>response.json()</code>，因为response只能做一次json处理，为了避免对CMS项目代码逻辑的影响，我们需要首先对response进行clone，再做json格式化处理，即<code>response.clone().json()</code>；此外，还需要注意，response返回的格式可能是blob的，不支持json转化，针对blob格式的response，做直接返回处理；</li>
<li><code>errorPlugin</code>插件负责捕获异常返回的http code，在上报收集的结果中，发现有一些已知的正常code，例如无权限异常code、未登录code，为了屏蔽这些code值对度量的影响，SDK提供了支持配置code白名单的功能；</li>
<li>在对请求数据的收集中，需要关注的业务相关的API，所以对于一些公共的API：日志上报、登录相关等接口，需要在上报的时候忽略这部分接口，与error code相似，SDK支持配置API白名单的功能。</li>
</ul>
<h2 id="监控数据可视化"><a href="#监控数据可视化" class="headerlink" title="监控数据可视化"></a>监控数据可视化</h2><p>在收集到SDK上报的数据后，为了更好地衡量CMS平台的性能，<a href="https://music-cms.hz.netease.com/themis-analysis/chart/home" target="_blank" rel="noopener">ThemisAnalysis</a>监控数据可视化平台对数据从不同维度做了数据聚合处理，包括指标维度、场景维度、请求维度、错误维度、页面维度等，以及抽象出CMS平台的健康模型；此外支持错误日志查询，在遇到问题的时候可以方便地查询出对应的请求数据。</p>
<h3 id="健康模型"><a href="#健康模型" class="headerlink" title="健康模型"></a>健康模型</h3><p>健康模型综合了场景指标、请求成功率和请求耗时数据，计算出健康指数的具体得分，给开发一个比较直观的关于平台健康度的反馈。<br><img src="https://p5.music.126.net/obj/wonDlsKUwrLClGjCm8Kx/15045900125/9dab/d7ea/7b93/b408a64ba63857093e01bce54c22c67f.png" alt><br>健康指数总分由场景指标性能得分、场景指标规范性、请求成功率得分、请求平均响应时间得分按照一定的占比计算得出，具体计算公式为：</p>
<blockquote>
<p>健康指数总分 = 场景指标性能得分 <em> x% + 场景指标规范性 </em> y% + 请求成功率得分 <em> z% + 请求平均响应时间得分 </em> m%</p>
</blockquote>
<p>各项指标具体的得分，主要是与各项指标推荐的基准值，根据我们预设的公式去计算，如果有明显不合理的地方，再去做动态调整，保证分数的合理性。<br>以场景指标性能得分为例，简单介绍下计算方法：</p>
<blockquote>
<p>场景指标性能得分 = (指标 1 得分 + 指标 2 得分 + …) / 指标数量</p>
</blockquote>
<p>场景指标性能得分为所有场景指标的平均分，综合考虑了该应用相关的所有指标。其中要计算单个指标得分，首先计算出<code>指标耗时/指标基准值</code>的比值，再根据这个比值按照梯度线性计算而得。例如当该<code>比值&lt;=1</code>时，很明显得分应该为<code>100</code>；比值越大，说明耗时越长，页面渲染耗时越长，反映在得分上越低。</p>
<h3 id="问题分析"><a href="#问题分析" class="headerlink" title="问题分析"></a>问题分析</h3><p>ThemisAnalysis平台会根据错误频率统计请求的高频错误，点击查看可以进一步查看错误详情，包括异常API地址、请求参数以及被影响的用户：<br><img src="https://p6.music.126.net/obj/wo3DlcOGw6DClTvDisK1/15048205515/b8f9/ef54/d53a/b9b13d5ee84433c75cf0f83d8d101956.png" width="560px"></p>
<p>确认了存在的异常后，通常情况下期望可以看到用户操作的上下文，所以会将SDK上报的请求相关数据汇总，支持查询操作；通过uid可以查询到具体的某个用户的操作链路，最大程度地帮助开发复现并解决问题。<br>除此之外，Themis项目-效能工具的开发中包括<code>问题上报插件</code>，目前音乐的CMS都可以使用该插件，推荐使用，入口如下：<br><img src="https://p6.music.126.net/obj/wo3DlcOGw6DClTvDisK1/15048248406/b7b1/d59f/6e2c/bef24fb46cccc6b56159e02ad82a8d6f.png" alt><br>结合该插件，可以帮助我们还原问题现场，相关原理可以参考我发表的另一篇文章<a href="https://juejin.cn/post/7049909933168394277/" target="_blank" rel="noopener">rrweb 带你还原问题现场</a>。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本文主要介绍了CMS性能监控的方案，简要介绍了数据格式的定义、监控SDK对数据的收集以及可视化平台的实现，希望这篇文章可以在相似场景中带给你一些小小的灵感。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://sherrywu0917.github.io/2023/05/20/Themis-CMS体验度量方案/" data-id="clsshtuw5000fwqrtif596kfl" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Themis，CMS体验度量方案/">Themis，CMS体验度量方案</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2023/07/02/webpack常用插件/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          webpack常用插件
        
      </div>
    </a>
  
  
    <a href="/2021/10/19/core-js3升级/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">core-js3升级处理</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/SSR/">SSR</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Themis，CMS体验度量方案/">Themis，CMS体验度量方案</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/autobind/">autobind</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/core-decorators/">core-decorators</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/css/">css</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/decorator/">decorator</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/decorators源码简析——debounce/">decorators源码简析——debounce</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/diff/">diff</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/echarts/">echarts</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/es6/">es6</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/es7/">es7</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/eventloop/">eventloop</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/font-face/">font-face</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hook/">hook</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/js/">js</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/lazyInitialize/">lazyInitialize</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/load/">load</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/loader/">loader</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/lottie/">lottie</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/npm包/">npm包</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/react/">react</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/readonly/">readonly</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/require/">require</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sass/">sass</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/setState/">setState</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sitespeed-io/">sitespeed.io</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/webp/">webp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/webpack/">webpack</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/下载/">下载</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/兼容/">兼容</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/函数式编程/">函数式编程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/前端性能优化/">前端性能优化</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/前端打包/">前端打包</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/原型链/">原型链</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/总结/">总结</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/插件/">插件</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/渲染/">渲染</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/组件开发/">组件开发</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/组合式继承/">组合式继承</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/继承/">继承</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/角度渐变/">角度渐变</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/高阶组件/">高阶组件</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/SSR/" style="font-size: 10px;">SSR</a> <a href="/tags/Themis，CMS体验度量方案/" style="font-size: 10px;">Themis，CMS体验度量方案</a> <a href="/tags/autobind/" style="font-size: 10px;">autobind</a> <a href="/tags/core-decorators/" style="font-size: 15.71px;">core-decorators</a> <a href="/tags/css/" style="font-size: 12.86px;">css</a> <a href="/tags/decorator/" style="font-size: 17.14px;">decorator</a> <a href="/tags/decorators源码简析——debounce/" style="font-size: 11.43px;">decorators源码简析——debounce</a> <a href="/tags/diff/" style="font-size: 14.29px;">diff</a> <a href="/tags/echarts/" style="font-size: 10px;">echarts</a> <a href="/tags/es6/" style="font-size: 10px;">es6</a> <a href="/tags/es7/" style="font-size: 10px;">es7</a> <a href="/tags/eventloop/" style="font-size: 11.43px;">eventloop</a> <a href="/tags/font-face/" style="font-size: 10px;">font-face</a> <a href="/tags/hook/" style="font-size: 10px;">hook</a> <a href="/tags/js/" style="font-size: 18.57px;">js</a> <a href="/tags/lazyInitialize/" style="font-size: 10px;">lazyInitialize</a> <a href="/tags/load/" style="font-size: 10px;">load</a> <a href="/tags/loader/" style="font-size: 10px;">loader</a> <a href="/tags/lottie/" style="font-size: 10px;">lottie</a> <a href="/tags/npm包/" style="font-size: 10px;">npm包</a> <a href="/tags/react/" style="font-size: 20px;">react</a> <a href="/tags/readonly/" style="font-size: 10px;">readonly</a> <a href="/tags/require/" style="font-size: 10px;">require</a> <a href="/tags/sass/" style="font-size: 10px;">sass</a> <a href="/tags/setState/" style="font-size: 10px;">setState</a> <a href="/tags/sitespeed-io/" style="font-size: 10px;">sitespeed.io</a> <a href="/tags/webp/" style="font-size: 10px;">webp</a> <a href="/tags/webpack/" style="font-size: 14.29px;">webpack</a> <a href="/tags/下载/" style="font-size: 10px;">下载</a> <a href="/tags/兼容/" style="font-size: 11.43px;">兼容</a> <a href="/tags/函数式编程/" style="font-size: 10px;">函数式编程</a> <a href="/tags/前端性能优化/" style="font-size: 12.86px;">前端性能优化</a> <a href="/tags/前端打包/" style="font-size: 10px;">前端打包</a> <a href="/tags/原型链/" style="font-size: 10px;">原型链</a> <a href="/tags/总结/" style="font-size: 12.86px;">总结</a> <a href="/tags/插件/" style="font-size: 10px;">插件</a> <a href="/tags/渲染/" style="font-size: 12.86px;">渲染</a> <a href="/tags/组件开发/" style="font-size: 10px;">组件开发</a> <a href="/tags/组合式继承/" style="font-size: 10px;">组合式继承</a> <a href="/tags/继承/" style="font-size: 11.43px;">继承</a> <a href="/tags/角度渐变/" style="font-size: 10px;">角度渐变</a> <a href="/tags/高阶组件/" style="font-size: 10px;">高阶组件</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/02/">February 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/11/">November 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/10/">October 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/09/">September 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/07/">July 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/05/">May 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">October 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/08/">August 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/07/">July 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">March 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">December 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">October 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">September 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">February 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">October 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">July 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">June 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2024/02/19/rrweb原理&录屏上报实践/">rrweb带你还原问题现场</a>
          </li>
        
          <li>
            <a href="/2024/02/19/react相关问题V2/">(no title)</a>
          </li>
        
          <li>
            <a href="/2024/02/19/module引入方式/">(no title)</a>
          </li>
        
          <li>
            <a href="/2024/02/19/js_roadmap/">(no title)</a>
          </li>
        
          <li>
            <a href="/2023/11/02/webpack-loader总结/">webpack-loader总结</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2024 Sherry<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>